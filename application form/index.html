<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Елена Толстых. Урок 7 JS</title>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  </head>
  <body>
    <div class="col-xs-10 col-xs-push-1 col-sm-8 col-sm-push-2 col-md-6 col-md-push-3">
      <div class="panel panel-primary">
        <h2 class="panel-heading panel-title text-center">Заявка для участия в олимпиаде</h2>
        <form class="panel-body">
          <label for="first_name" class="control-label">Имя*</label>
          <input type="text" class="form-control" name="first_name" data-validate="required" data-field="first_name" autofocus>

          <br>
          <label for="last_name" class="control-label">Фамилия</label>
          <input type="text" class="form-control" name="last_name" data-field="last_name">

          <br>
          <div class="row">
            <div class="col-xs-12 col-sm-3">
              <label for="age" class="control-label">Возраст</label>
              <input type="number" min="0" class="form-control" name="age" data-field="age">
            </div>
            <div class="col-xs-12 col-sm-9">
              <label for="status" class="control-label">Статус*</label>
              <select class="form-control" name="status" data-validate="select" data-field="status">
                <option value="-1">Выбрать...</option>
                <option value="0">Школьник</option>
                <option value="1">Студент</option>
                <option value="2">Профи</option>
                <option value="3">Эксперт</option>
                <option value="4">Случайный прохожий</option>
              </select>
            </div>
          </div>

          <br>
          <label for="email" class="control-label">E-mail*</label>
          <input type="email" class="form-control" name="email" data-validate="required, email" data-field="email" title="Введите существующий e-mail">

          <br>
          <label for="languages" class="control-label">Языки программирования (можно выбрать несколько)*</label>
          <select class="form-control" name="languages[]" size="5" data-validate="select" data-field="languages" multiple>
            <option value="0">JavaScript</option>
            <option value="1">PHP</option>
            <option value="2">Python</option>
            <option value="3">Swift</option>
            <option value="4">C++</option>
            <option value="5">Assembler</option>
          </select>

          <fieldset class="panel">
            <legend class="panel-heading panel-title label">Раньше участвовали в олимпиадах?</legend>
            <div class="panel-body row">
              <label class="control-label col-xs-2 col-xs-push-5"><input type="radio" name="experience" data-field="experience" value="1">Да</label>
              <label class="control-label col-xs-2 col-xs-push-4"><input type="radio" name="experience" data-field="experience" value="0" checked>Нет</label>
            </div>
          </fieldset>

          <button name="submit" class="btn btn-primary pull-right">Отправить</button>
        </form>
      </div>
    </div>

    <script>
        window.onload = function() {
            var errorMessages = {
                'inputRequired': 'Пожалуйста, заполните это поле',
                'inputEmail': 'Пожалуйста, введите корректный e-mail',
                'inputSelect': 'Пожалуйста, выберите что-нибудь'
            };

            cleanAllFields();

            _$('[name="age"]').onkeydown = function(event) {
                var rightKeyCodes = [8, 9, 16, 17, 37, 38, 39, 40, 46, 116];
                if (!(+event.key || rightKeyCodes.some(item => item === event.keyCode))) {
                    event.preventDefault();
                }
            }

            _$$('[data-validate]').forEach(function(item) {
                item.onfocus = function() {
                    cleanSendSuccess();
                    cleanValidationError.call(item);
                    item.setAttribute('style', 'border-color: default');
                }
                item.onblur = function () {
                    validation.call(item);
                }
            });

            _$('form').onsubmit = function() {
                var success = true;
                var buttonSubmit = _$('[name="submit"]');

                cleanSendSuccess();
                _$$('[data-validate]').forEach(function(item) {
                    if (!validation.call(item)) {
                        success = false;
                    }
            	});
                if (success) {
                    addResultString();
                    addMessage.call(buttonSubmit, 'Данные успешно отправлены', 'green', 'send-success');
                    cleanAllFields();
                }

            	return false;
            }

            function validation() {
                var success = true;
                var roles = this.dataset.validate.split(',');
                var item = this;

                cleanValidationError.call(this);
                roles.forEach(function(role) {
                    role = role.trim()
                    if (!isValid.call(item, role)) {
                        success = false;
                        item.setAttribute('style', 'border-color: red');
                        addValidationError.call(item, errorMessages[buildValidateName('input', role)]);
                    }
            	});

                return success;
            }

            function isValid(role) {
            	var validationFunctionName = buildValidateName('validate', role);

            	return window[validationFunctionName].call(this);
            }

            function addValidationError(message) {
                var error = addMessage.call(this, message, 'red', 'error-message');
            }

            function cleanValidationError() {
                var nextElement = this.nextElementSibling;

                while(nextElement && nextElement.classList.contains('error-message')) {
                    nextElement.parentNode.removeChild(nextElement);
                    nextElement = this.nextElementSibling;
                }
            }

            function cleanSendSuccess() {
                _$$('.send-success').forEach(function(item) {
                    item.parentNode.removeChild(item);
                });
            }

            function cleanAllFields() {
                _$$('[type="text"], [type="number"], [type="email"]').forEach(function(item) {
                    item.value = '';
                });
                _$$('[type="radio"]').forEach(function(item) {
                    if (item.hasAttribute('checked')) {
                        item.checked = true;
                    }
                });
                _$$('select').forEach(function(item) {
                    item.value = -1;
                });
            }

            function addResultString() {
                var dataValue;
                var dataField;
                var resultString = '';
                var buttonSubmit = _$('[name="submit"]');

                _$$('[data-field]').forEach(function(item) {
                    dataValue = item.value;
                    dataField = item.getAttribute('data-field');

                    if (item.tagName.toLowerCase() === 'select') {
                        var optionsArray = [];
                        item.querySelectorAll('option').forEach(function(option) {
                            if (option.selected) {
                                optionsArray.push(option.value);
                            }
                        });
                        dataValue = optionsArray.toString();
                    }
                    if (item.getAttribute('type') === 'radio') {
                        if (!item.checked) {
                            dataField = '';
                            dataValue = '';
                        }
                    }

                    if (dataField) {
                        resultString += '&' + dataField + '=' + dataValue;
                    }
                });
                addMessage.call(buttonSubmit, resultString, 'blue' , 'send-success');
                //location += resultString;
            }
        }

        function _$(selector) {
            return document.querySelector(selector);
        }

        function _$$(selector) {
            return document.querySelectorAll(selector);
        }

        function buildValidateName(prefix, rule) {
            return prefix + rule.slice(0, 1).toUpperCase() + rule.slice(1);
        }

        function validateRequired() {
        	return this.value !== '';
        }

        function validateEmail() {
        	var re = /^(([^<>()\[\]\.,;:\s@\"]+(\.[^<>()\[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i;

        	return re.test(this.value);
        }

        function validateSelect() {
        	return (this.value !== '') && (+this.value !== -1);
        }

        function addMessage(text, color, messageClass) {
            var message = document.createElement('span');

            message.setAttribute('style', 'color: ' + color);
            message.innerHTML = text + '<br>';
            if (messageClass) {
                message.classList.add(messageClass);
            }
            this.parentNode.insertBefore(message, this.nextElementSibling);

            return message;
        }

    </script>
  </body>
</html>
